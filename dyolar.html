<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DYOLAR - La Monnaie SacrÃ©e</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #0b0b0b;
      color: #f1f1f1;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      padding: 2em;
      background: #111;
      border-bottom: 3px solid gold;
    }
    h1 {
      font-size: 2.5em;
      color: gold;
    }
    .section {
      padding: 2em 1em;
      max-width: 900px;
      margin: 0 auto;
    }
    .price {
      font-size: 2em;
      margin: 1em 0;
    }
    .change {
      font-size: 1.1em;
      margin-left: 0.5em;
      font-weight: bold;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1em auto;
      max-width: 900px;
    }
    .airdrop {
      background: #222;
      border: 2px dashed gold;
      padding: 2em;
      margin: 2em 0;
    }
    .btn {
      background: gold;
      color: black;
      padding: 0.8em 1.5em;
      border: none;
      cursor: pointer;
      font-size: 1em;
      margin-top: 1em;
    }
    .timeframe-buttons {
      margin-top: 1em;
    }
    .timeframe-buttons button {
      margin: 0 0.3em;
      padding: 0.4em 0.8em;
      background: #333;
      color: white;
      border: 1px solid #888;
      cursor: pointer;
      font-weight: bold;
    }
    .timeframe-buttons button.active {
      background: gold;
      color: black;
      border-color: gold;
    }
    .admin-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      background: #111;
      border-top: 2px solid gold;
      padding: 1em;
      display: none;
      width: 100%;
      color: gold;
      font-weight: bold;
      z-index: 999;
    }
    footer {
      background: #111;
      padding: 1em;
      font-size: 0.9em;
      color: #999;
    }
    input[type=number], input[type=text] {
      font-size: 1em;
      padding: 0.3em;
      width: 120px;
      margin-right: 1em;
      border: 1px solid #444;
      border-radius: 3px;
      background: #222;
      color: #f1f1f1;
    }
    input[type=text] {
      width: 200px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ’° DYOLAR : La Crypto-monnaie du DYOLISSIME</h1>
    <p>Rejoins la COMMU des Crypto BROS !</p>
  </header>

  <div class="section">
    <h2>Cours actuel du $DYOLAR</h2>
    <p class="price">
      1 DYOLAR = <span id="dyoprice">-</span> UPP
      <span id="change" class="change">-</span>
    </p>

    <div class="chart-container">
      <canvas id="dyolarChart"></canvas>
    </div>

    <div class="timeframe-buttons">
      <button type="button" onclick="setTimeframe(1)" id="btn-1h">1h</button>
      <button type="button" onclick="setTimeframe(24)" id="btn-24h" class="active">1j</button>
      <button type="button" onclick="setTimeframe(72)" id="btn-3d">3j</button>
      <button type="button" onclick="setTimeframe(168)" id="btn-7d">1 semaine</button>
    </div>
  </div>

  <div class="section airdrop">
    <h2>ðŸ”¥ Airdrop SacrÃ© !</h2>
    <p>RÃ©clame 69 DYOLARS offerts par le DYOLISSIME.</p>
    <input type="text" id="pseudo" placeholder="Ton nom de BRO" autocomplete="off" />
    <br />
    <button type="button" class="btn" onclick="claimAirdrop()">CLAIMER TON AIRDROP</button>
    <p id="claimMsg"></p>
  </div>

  <div id="adminPanel" class="admin-panel" aria-hidden="true">
    <h3>ðŸ“ˆ Ajuster le cours manuellement</h3>
    <input type="number" id="manualInput" step="0.01" min="0.01" placeholder="Nouveau prix" />
    <button type="button" onclick="setManualPrice()">Mettre Ã  jour</button>
  </div>

  <footer>
    *UnitÃ©s de Poulet-PÃ¢tes â€” DYOLARâ„¢ n'est pas une vraie crypto (encore) â€” Gloire au D.
  </footer>

<script>
  // === CONFIG SUPABASE ===
  const SUPABASE_URL = 'https://sxjocrdqiotmshssenyi.supabase.co'; // <-- remplace par ton URL Supabase
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4am9jcmRxaW90bXNoc3NlbnlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2OTIxMjIsImV4cCI6MjA2NDI2ODEyMn0.WkRU3iXa832z3D2zRlNplXcqIu1EHnVmx_RK11q-yaM'; // <-- remplace par ta clÃ© publique anon
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const priceEl = document.getElementById('dyoprice');
  const changeEl = document.getElementById('change');
  const ctx = document.getElementById('dyolarChart').getContext('2d');

  let data = []; // tableau {time, value}
  let currentPrice = 3.14; // prix par dÃ©faut si rien en base
  let currentRange = 24; // affichage par dÃ©faut (24h)
  let lastSavedPrice = null;

  // Initialisation Chart.js
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Cours du DYOLAR',
        data: [],
        borderColor: 'gold',
        backgroundColor: 'rgba(255, 215, 0, 0.2)',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: {
            tooltipFormat: 'HH:mm:ss',
            unit: 'hour',
            displayFormats: {
              hour: 'HH:mm',
              minute: 'HH:mm',
              second: 'HH:mm:ss'
            }
          },
          ticks: { color: 'white' },
          grid: { color: '#333' }
        },
        y: {
          beginAtZero: false,
          ticks: { color: 'white' },
          grid: { color: '#333' }
        }
      },
      plugins: {
        legend: {
          labels: { color: 'gold' }
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      interaction: {
        mode: 'nearest',
        intersect: false
      }
    }
  });

  // Met Ã  jour lâ€™affichage prix + variation
  function updateDisplay() {
    priceEl.textContent = currentPrice.toFixed(2);
    if (lastSavedPrice === null) {
      changeEl.textContent = "-";
      changeEl.style.color = 'white';
      return;
    }
    const change = ((currentPrice - lastSavedPrice) / lastSavedPrice) * 100;
    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
    changeEl.style.color = change >= 0 ? 'lightgreen' : 'crimson';
  }

  // Filtrer les donnÃ©es pour la plage temporelle actuelle
  function getFilteredData() {
    const now = Date.now();
    const minTime = now - currentRange * 60 * 60 * 1000;
    return data.filter(d => d.time >= minTime);
  }

  // Recharge le graphique selon la plage temporelle
  function refreshChart() {
    const filtered = getFilteredData();
    chart.data.labels = filtered.map(d => new Date(d.time));
    chart.data.datasets[0].data = filtered.map(d => d.value);
    chart.update();
  }

  // RÃ©cupÃ©rer lâ€™historique complet (limitÃ© Ã  7 jours max ici)
  async function loadData() {
    let { data: rows, error } = await supabase
      .from('dyolar_prices')
      .select('*')
      .order('timestamp', { ascending: true })
      .gte('timestamp', new Date(Date.now() - 7*24*60*60*1000).toISOString());
    if (error) {
      console.error('Erreur chargement Supabase:', error);
      return;
    }
    if (rows.length === 0) {
      // Pas de donnÃ©es en base, on initialise
      data = [{ time: Date.now(), value: currentPrice }];
      lastSavedPrice = currentPrice;
      return;
    }
    // Formatage
    data = rows.map(r => ({
      time: new Date(r.timestamp).getTime(),
      value: parseFloat(r.price)
    }));
    lastSavedPrice = data[data.length - 1].value;
    currentPrice = lastSavedPrice;
  }

  // Ajoute un nouveau prix en base Supabase
  async function addPriceToDB(newPrice) {
    const now = new Date().toISOString();
    const { error } = await supabase.from('dyolar_prices').insert([{ price: newPrice, timestamp: now }]);
    if (error) {
      console.error('Erreur insertion Supabase:', error);
      return false;
    }
    return true;
  }

  // Gestion du bouton de timeframe
  function setTimeframe(hours) {
    currentRange = hours;
    document.querySelectorAll('.timeframe-buttons button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.getElementById('btn-' + (hours === 168 ? '7d' : hours + (hours === 1 ? 'h' : '')))?.classList.add('active');
    refreshChart();
  }

  // Claim airdrop function
  async function claimAirdrop() {
    const pseudoInput = document.getElementById('pseudo');
    const msg = document.getElementById('claimMsg');
    const pseudo = pseudoInput.value.trim().toUpperCase();

    if (!pseudo) {
      msg.textContent = "Merci d'entrer ton nom de BRO.";
      msg.style.color = 'crimson';
      return;
    }
    if (pseudo.length > 15) {
      msg.textContent = "Nom trop long, max 15 caractÃ¨res.";
      msg.style.color = 'crimson';
      return;
    }

    // VÃ©rifier si dÃ©jÃ  rÃ©clamÃ©
    let { data: claims, error } = await supabase
      .from('airdrops')
      .select('*')
      .eq('pseudo', pseudo);

    if (error) {
      msg.textContent = "Erreur rÃ©seau, rÃ©essaie plus tard.";
      msg.style.color = 'crimson';
      return;
    }
    if (claims.length > 0) {
      msg.textContent = "Tu as dÃ©jÃ  rÃ©clamÃ© ton airdrop, BRO.";
      msg.style.color = 'orange';
      return;
    }

    // InsÃ©rer la rÃ©clamation
    const { error: insertError } = await supabase
      .from('airdrops')
      .insert([{ pseudo: pseudo, amount: 69, timestamp: new Date().toISOString() }]);

    if (insertError) {
      msg.textContent = "Erreur serveur, rÃ©essaie plus tard.";
      msg.style.color = 'crimson';
      return;
    }

    msg.textContent = `ðŸ”¥ Airdrop de 69 DYOLAR envoyÃ© Ã  ${pseudo} ! Gloire au DYOLISSIME !`;
    msg.style.color = 'lightgreen';
    pseudoInput.value = '';
  }

  // Fonction admin : mettre Ã  jour le prix manuellement
  async function setManualPrice() {
    const input = document.getElementById('manualInput');
    const newPrice = parseFloat(input.value);
    if (isNaN(newPrice) || newPrice <= 0) {
      alert("Prix invalide.");
      return;
    }
    currentPrice = newPrice;
    const success = await addPriceToDB(newPrice);
    if (success) {
      data.push({ time: Date.now(), value: newPrice });
      lastSavedPrice = newPrice;
      updateDisplay();
      refreshChart();
      input.value = '';
      alert('Prix mis Ã  jour avec succÃ¨s.');
    }
  }

  // Convertir input pseudo en majuscule en temps rÃ©el
  document.getElementById('pseudo').addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });

  // DÃ©tection simple d'admin par mot de passe (prompt)
  function checkAdmin() {
    const pwd = prompt("Mot de passe admin DYOLAR ?");
    if (pwd === "DYOLISSIME2025") {
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('adminPanel').setAttribute('aria-hidden', 'false');
    }
  }

  // Initialisation
  async function init() {
    await loadData();
    updateDisplay();
    refreshChart();
    // affichage admin au clic rapide 5 fois sur header (exemple)
    let clicks = 0;
    document.querySelector('header').addEventListener('click', () => {
      clicks++;
      if (clicks === 5) {
        checkAdmin();
        clicks = 0;
      }
      setTimeout(() => { clicks = 0; }, 1000);
    });
  }

  init();
</script>
</body>
</html>
